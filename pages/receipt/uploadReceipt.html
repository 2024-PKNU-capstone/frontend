<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì˜ìˆ˜ì¦ ë“±ë¡</title>
  <link rel="stylesheet" href="../../CSS/main.css">
  <!-- ì™¸ë¶€ CSS íŒŒì¼ ë§í¬ -->
  <link rel="stylesheet" href="../../CSS/receipt/uploadReceipt.css">
  <!-- jQuery ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
  <!-- í—¤ë” ì‹œì‘ -->
  <div class="app-header-background"></div>
  <header class="app-header">
      <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
      <button class="icon-button" onclick="history.back()">
          <img class="back" src="../../resource/icons/icons8-ë’¤ë¡œ-24.png" width="30px" alt="Back"> <!-- back icon path -->
      </button>

      <!-- ì¤‘ì•™ ë¡œê³  -->
      <div class="logo">
          <img src="../../resource/icons/ì¥ë¶€ë¡œê³ (í™”ì´íŠ¸).png" alt="ë´‰ì¥ë¶€ ë¡œê³ "> <!-- logo path -->
      </div>

      <!-- ë©”ë‰´ ë²„íŠ¼ -->
      <button class="icon-button">
          <img class ="menu" src="../../resource/icons/icons8-í–„ë²„ê±°-24.png" width="30px" alt="Menu"> <!-- menu icon path -->
      </button>
  </header>

  <div class="main-container">
      <!-- í”„ë¡œí•„ ì„¹ì…˜ -->
      <div class="profile-section">
          <!-- ì™¼ìª½ ëŒ€í•™ ì •ë³´ ë° ì´ë¦„ ìˆ˜ì§ ë°°ì—´ -->
          <div class="profile-left">
              <p class="university">ë¡œë”©ì¤‘</p> <!-- ëŒ€í•™ ì •ë³´ -->
              <p class="name"></p> <!-- ì´ë¦„ -->
          </div>
          <!-- ì˜¤ë¥¸ìª½ ì—­í•  ë° í•™ë²ˆ ìˆ˜í‰ ë°°ì—´ -->
          <div class="role-info">
              <p class="role"></p> <!-- ì—­í•  -->
              <p class="id"></p> <!-- í•™ë²ˆ -->
          </div>
      </div>
      <div class="upload-section">
        <h3>ì˜ìˆ˜ì¦ ì—…ë¡œë“œ</h3>
        <p class="upload-instruction">
            ğŸ’¡ ì •í™•í•œ OCR ì²˜ë¦¬ë¥¼ ìœ„í•´ í•„ìš”í•œ ì˜ì—­ì´ ì˜ ë³´ì´ë„ë¡ ì´¬ì˜í•´ì£¼ì„¸ìš”.
        </p>
        
        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
        <div class="preview-container" onclick="document.getElementById('cameraInput').click();">
          <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìœ„í•œ <img> ìš”ì†Œë¡œ, ì„ íƒí•œ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
          <img id="preview" alt="Preview Image" style="display: none;">
          <!-- '+' ì•„ì´ì½˜ -->
          <div id="add-icon" class="add-icon">+</div>
      </div>

      <!-- ë“±ë¡ ë²„íŠ¼ -->
      <div class="button-container">
          <button class="upload-button" onclick="uploadReceipt()">ë“±ë¡í•˜ê¸°</button>
      </div>

      <!-- íŒŒì¼ ì…ë ¥ í•„ë“œ -->
      <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="showPreview(event)">
    </div>    
  </div>

  <!-- íŒŒì¼ ì…ë ¥ í•„ë“œ (ì¹´ë©”ë¼ ì‚¬ìš© í¬í•¨) -->
  <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="showPreview(event)">
  <!-- 
    accept="image/*": ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥
    capture="environment": ê¸°ë³¸ì ìœ¼ë¡œ í›„ë©´ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ìº¡ì²˜
    style="display:none": í™”ë©´ì— í‘œì‹œë˜ì§€ ì•Šë„ë¡ ìˆ¨ê¹€
    onchange="showPreview(event)": íŒŒì¼ì´ ì„ íƒë˜ë©´ showPreview í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
  -->

  <script type="module">
    import { API_BASE_URL} from '../../config.js';

    function showPreview(event) {
        const file = event.target.files[0]; // ì„ íƒëœ íŒŒì¼
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById("preview");
                const addIcon = document.getElementById("add-icon");

                preview.src = e.target.result; // ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„¤ì •
                preview.style.display = "block"; // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ í‘œì‹œ
                addIcon.style.display = "none"; // '+' ì•„ì´ì½˜ ìˆ¨ê¹€
            };
            reader.readAsDataURL(file); // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•˜ì—¬ ì½ìŒ
        } else {
            alert("íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
    }
    function uploadReceipt() {
    const fileInput = document.getElementById('cameraInput'); // íŒŒì¼ ì…ë ¥ í•„ë“œ ì„ íƒ
    const files = fileInput.files; // ì„ íƒëœ íŒŒì¼ ëª©ë¡

    // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ê²½ê³  ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  í•¨ìˆ˜ ì¢…ë£Œ
    if (files.length === 0) {
      alert("ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    const formData = new FormData(); // íŒŒì¼ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ê¸° ìœ„í•´ FormData ê°ì²´ ìƒì„±

    // ì„ íƒëœ íŒŒì¼ì„ FormDataì— ì¶”ê°€
    $.each(files, function (i, file) {
      formData.append("files", file); // ì„œë²„ì—ì„œ @RequestParam("files")ë¡œ ë§¤í•‘
    });

    // documentIdë¥¼ ì˜µì…”ë„í•˜ê²Œ ì¶”ê°€
    const documentId = 123; // í•„ìš”í•œ ê²½ìš° ë™ì ìœ¼ë¡œ ì„¤ì • (ì˜ˆ: ì‚¬ìš©ì ì…ë ¥ì´ë‚˜ ì„ íƒê°’ ê¸°ë°˜)
    if (documentId) {
      formData.append("documentId", documentId);
    }

    // AJAX ìš”ì²­ì„ í†µí•´ ì„œë²„ì— íŒŒì¼ ì—…ë¡œë“œ
    $.ajax({
      url: `${API_BASE_URL}/api/upload/receipt`, // ì„œë²„ API URL
      type: 'POST', // HTTP ë©”ì„œë“œ: POST ì‚¬ìš©
      headers: {
        "Authorization": `Bearer ${localStorage.getItem('accessToken')}`, // ì¸ì¦ í† í° (API ëª…ì„¸ì„œì— ë”°ë¼ ë³€ê²½)
      },
      data: formData, // FormData ê°ì²´ (íŒŒì¼ ë°ì´í„° í¬í•¨)
      contentType: false, // íŒŒì¼ ì—…ë¡œë“œ ì‹œ í•„ìš”: ê¸°ë³¸ contentType ì‚¬ìš© ì•ˆ í•¨
      processData: false, // ë°ì´í„°ì˜ ìë™ ë³€í™˜ ë°©ì§€ (íŒŒì¼ ì—…ë¡œë“œ ì‹œ í•„ìš”)

      // ìš”ì²­ ì„±ê³µ ì‹œ ì‹¤í–‰ë˜ëŠ” ì½œë°± í•¨ìˆ˜
      success: function (response, status, xhr) {
        console.log(response)
        if (response.code === 201) { // HTTP ìƒíƒœ ì½”ë“œ 201(Created)ì¼ ê²½ìš°
          alert("ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ì„±ê³µ: " + response.message); // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        }
      },

      // ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì‹¤í–‰ë˜ëŠ” ì½œë°± í•¨ìˆ˜
      error: function (xhr, status, error) {
        alert("ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ì‹¤íŒ¨: " + xhr.responseText); // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
      }
  });
}
window.showPreview=showPreview;
window.uploadReceipt=uploadReceipt;
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="module"  src="../../js/main/main_info.js"></script>
</body>
</html>