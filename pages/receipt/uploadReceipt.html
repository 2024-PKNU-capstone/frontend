<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>영수증 등록</title>
  <link rel="stylesheet" href="../../CSS/main.css">
  <!-- 외부 CSS 파일 링크 -->
  <link rel="stylesheet" href="../../CSS/receipt/uploadReceipt.css">
  <!-- jQuery 라이브러리 추가 -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
  <!-- 헤더 시작 -->
  <div class="app-header-background"></div>
  <header class="app-header">
      <!-- 뒤로가기 버튼 -->
      <button class="icon-button" onclick="history.back()">
          <img class="back" src="../../resource/icons/icons8-뒤로-24.png" width="30px" alt="Back"> <!-- back icon path -->
      </button>

      <!-- 중앙 로고 -->
      <div class="logo">
          <img src="../../resource/icons/장부로고(화이트).png" alt="봉장부 로고"> <!-- logo path -->
      </div>

      <!-- 메뉴 버튼 -->
      <button class="icon-button">
          <img class ="menu" src="../../resource/icons/icons8-햄버거-24.png" width="30px" alt="Menu"> <!-- menu icon path -->
      </button>
  </header>

  <div class="main-container">
      <!-- 프로필 섹션 -->
      <div class="profile-section">
          <!-- 왼쪽 대학 정보 및 이름 수직 배열 -->
          <div class="profile-left">
              <p class="university">로딩중</p> <!-- 대학 정보 -->
              <p class="name"></p> <!-- 이름 -->
          </div>
          <!-- 오른쪽 역할 및 학번 수평 배열 -->
          <div class="role-info">
              <p class="role"></p> <!-- 역할 -->
              <p class="id"></p> <!-- 학번 -->
          </div>
      </div>
      <div class="upload-section">
        <h3>영수증 업로드</h3>
        <p class="upload-instruction">
            💡 정확한 OCR 처리를 위해 필요한 영역이 잘 보이도록 촬영해주세요.
        </p>
        
        <!-- 이미지 미리보기 영역 -->
        <div class="preview-container" onclick="document.getElementById('cameraInput').click();">
          <!-- 이미지 미리보기를 위한 <img> 요소로, 선택한 이미지가 여기에 표시됨 -->
          <img id="preview" alt="Preview Image" style="display: none;">
          <!-- '+' 아이콘 -->
          <div id="add-icon" class="add-icon">+</div>
      </div>

      <!-- 등록 버튼 -->
      <div class="button-container">
          <button class="upload-button" onclick="uploadReceipt()">등록하기</button>
      </div>

      <!-- 파일 입력 필드 -->
      <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="showPreview(event)">
    </div>    
  </div>

  <!-- 파일 입력 필드 (카메라 사용 포함) -->
  <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="showPreview(event)">
  <!-- 
    accept="image/*": 이미지 파일만 선택 가능
    capture="environment": 기본적으로 후면 카메라를 사용하여 이미지를 캡처
    style="display:none": 화면에 표시되지 않도록 숨김
    onchange="showPreview(event)": 파일이 선택되면 showPreview 함수를 호출하여 미리보기 업데이트
  -->

  <script type="module">
    import { API_BASE_URL} from '../../config.js';

    function showPreview(event) {
        const file = event.target.files[0]; // 선택된 파일
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById("preview");
                const addIcon = document.getElementById("add-icon");

                preview.src = e.target.result; // 이미지 소스 설정
                preview.style.display = "block"; // 미리보기 이미지 표시
                addIcon.style.display = "none"; // '+' 아이콘 숨김
            };
            reader.readAsDataURL(file); // 파일을 Base64로 변환하여 읽음
        } else {
            alert("파일을 선택하지 않았습니다.");
        }
    }
    function uploadReceipt() {
    const fileInput = document.getElementById('cameraInput'); // 파일 입력 필드 선택
    const files = fileInput.files; // 선택된 파일 목록

    // 파일이 선택되지 않았을 경우 경고 메시지를 표시하고 함수 종료
    if (files.length === 0) {
      alert("업로드할 파일을 선택하세요.");
      return;
    }

    const formData = new FormData(); // 파일을 서버로 전송하기 위해 FormData 객체 생성

    // 선택된 파일을 FormData에 추가
    $.each(files, function (i, file) {
      formData.append("files", file); // 서버에서 @RequestParam("files")로 매핑
    });

    // documentId를 옵셔널하게 추가
    const documentId = 123; // 필요한 경우 동적으로 설정 (예: 사용자 입력이나 선택값 기반)
    if (documentId) {
      formData.append("documentId", documentId);
    }

    // AJAX 요청을 통해 서버에 파일 업로드
    $.ajax({
      url: `${API_BASE_URL}/api/upload/receipt`, // 서버 API URL
      type: 'POST', // HTTP 메서드: POST 사용
      headers: {
        "Authorization": `Bearer ${localStorage.getItem('accessToken')}`, // 인증 토큰 (API 명세서에 따라 변경)
      },
      data: formData, // FormData 객체 (파일 데이터 포함)
      contentType: false, // 파일 업로드 시 필요: 기본 contentType 사용 안 함
      processData: false, // 데이터의 자동 변환 방지 (파일 업로드 시 필요)

      // 요청 성공 시 실행되는 콜백 함수
      success: function (response, status, xhr) {
        console.log(response)
        if (response.code === 201) { // HTTP 상태 코드 201(Created)일 경우
          alert("영수증 업로드 성공: " + response.message); // 성공 메시지 표시
        }
      },

      // 요청 실패 시 실행되는 콜백 함수
      error: function (xhr, status, error) {
        alert("영수증 업로드 실패: " + xhr.responseText); // 오류 메시지 표시
      }
  });
}
window.showPreview=showPreview;
window.uploadReceipt=uploadReceipt;
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="module"  src="../../js/main/main_info.js"></script>
</body>
</html>